<!-- 🌫 Fondo desenfocado -->
<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 backdrop-blur-sm">
  <div
    class="bg-[var(--bg-primary)] text-[var(--text-primary)] rounded-2xl shadow-xl w-full max-w-lg max-h-[90vh] p-6 overflow-y-auto relative">

    <!-- 🧩 Cabecera -->
    <div class="flex items-center justify-between mb-6">
      <h2 class="text-xl font-semibold">{{ title }}</h2>
      <button (click)="cerrar.emit()"
        class="text-[var(--text-secondary)] hover:text-[var(--accent)] text-lg font-bold transition" title="Cerrar">
        ✕
      </button>
    </div>

    <!-- 📝 Formulario -->
    <form [formGroup]="form" [ngClass]="{
        'grid gap-6': true,
        'md:grid-cols-2': usarDosColumnas
      }">
      @for (campo of fields; track campo.name) {

      @if (campo.type === 'hidden') {
      <input type="hidden" [formControlName]="campo.name" />
      }

      @else if (campo.readonly) {
      <div class="w-full px-3 py-2 bg-[var(--bg-muted)] rounded text-sm md:col-span-2">
        <label class="block text-sm font-medium text-[var(--text-secondary)] mb-1">{{ campo.label }}</label>
        {{ getValorMostrado(campo.name) }}
      </div>
      }

      @else {
      <div class="relative" [ngClass]="{ 'md:col-span-2': campo.type === 'textarea' }">
        @switch (campo.type) {
        @case ('textarea') {
        <textarea [formControlName]="campo.name" id="{{ campo.name }}" rows="4"
          class="peer w-full pt-6 pb-2 px-3 border rounded-lg resize-none
                 border-[var(--border-default)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]
                 [class.border-[var(--danger)]]='form.get(campo.name)?.touched && form.get(campo.name)?.invalid'"></textarea>
        }

        @case ('select') {
        <select [formControlName]="campo.name" id="{{ campo.name }}" class="peer w-full pt-6 pb-2 px-3 border rounded-lg bg-white
                 border-[var(--border-default)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]
                 [class.border-[var(--danger)]]='form.get(campo.name)?.touched && form.get(campo.name)?.invalid'">
          <option disabled value="">Seleccione...</option>
          @if (campo.name === 'clienteId') {
          @for (c of clientes(); track c.id) {
          <option [value]="c.id">{{ c.nombre }}</option>
          }
          } @else if (campo.name === 'polizaId') {
          @for (p of polizasFiltradas(); track p.id) {
          <option [value]="p.id">{{ p.label }}</option>
          }
          } @else if (campo.name === 'empresaAseguradoraId') {
          @for (a of aseguradoras(); track a.id) {
          <option [value]="a.id">{{ a.nombre }}</option>
          }
          } @else {
          @for (opt of campo.options; track opt) {
          <option [value]="typeof opt === 'string' ? opt : opt.value">
            {{ typeof opt === 'string' ? opt : opt.label }}
          </option>
          }
          }
        </select>
        }

        @case ('datetime') {
        <input type="datetime-local" [formControlName]="campo.name" id="{{ campo.name }}" class="peer w-full pt-6 pb-2 px-3 border rounded-lg
                 border-[var(--border-default)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]
                 [class.border-[var(--danger)]]='form.get(campo.name)?.touched && form.get(campo.name)?.invalid'" />
        }

        @case ('file') {
        <input type="file" [formControlName]="campo.name" id="{{ campo.name }}" class="peer w-full pt-6 pb-2 px-3 border rounded-lg
                 border-[var(--border-default)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]
                 [class.border-[var(--danger)]]='form.get(campo.name)?.touched && form.get(campo.name)?.invalid'" />
        }

        @default {
        <input [type]="campo.type || 'text'" [formControlName]="campo.name" id="{{ campo.name }}" class="peer w-full pt-6 pb-2 px-3 border rounded-lg
                 border-[var(--border-default)] focus:outline-none focus:ring-2 focus:ring-[var(--accent)]
                 [class.border-[var(--danger)]]='form.get(campo.name)?.touched && form.get(campo.name)?.invalid'" />
        }
        }

        <!-- 🏷 Label flotante -->
        <label [for]="campo.name" class="absolute left-3 -top-2 px-1 text-sm bg-[var(--bg-primary)] text-[var(--text-secondary)] transition-all
                 peer-placeholder-shown:top-3 peer-placeholder-shown:text-base peer-placeholder-shown:text-[var(--text-secondary-muted)]
                 peer-focus:-top-2 peer-focus:text-sm peer-focus:text-[var(--accent)]">
          {{ campo.label }}
        </label>

        <!-- 🚫 Validaciones -->
        @if (form.get(campo.name)?.touched && form.get(campo.name)?.invalid) {
        <div class="text-sm text-[var(--danger)] mt-1 ml-1 space-y-1">
          @if (form.get(campo.name)?.errors?.['required']) {
          <div>🚫 Este campo es obligatorio.</div>
          }
          @if (form.get(campo.name)?.errors?.['email']) {
          <div>🚫 Debe ingresar un correo electrónico válido.</div>
          }
          @if (form.get(campo.name)?.errors?.['maxlength']) {
          <div>🚫 Máximo permitido: {{ form.get(campo.name)?.errors?.['maxlength'].requiredLength }} caracteres.</div>
          }
          @if (form.get(campo.name)?.errors?.['minlength']) {
          <div>🚫 Mínimo requerido: {{ form.get(campo.name)?.errors?.['minlength'].requiredLength }} caracteres.</div>
          }
          @if (form.get(campo.name)?.errors?.['min']) {
          <div>🚫 Valor mínimo: {{ form.get(campo.name)?.errors?.['min'].min }}.</div>
          }
          @if (form.get(campo.name)?.errors?.['max']) {
          <div>🚫 Valor máximo: {{ form.get(campo.name)?.errors?.['max'].max }}.</div>
          }
          @if (form.get(campo.name)?.errors?.['pattern']) {
          <div>🚫 Formato inválido para este campo.</div>
          }
        </div>
        }
      </div>
      }
      }
    </form>

    <!-- 📎 Botones -->
    <div class="mt-6 flex justify-end gap-2">
      @if (showCancelar) {
      <button (click)="cerrar.emit()"
        class="px-4 py-2 rounded bg-[var(--bg-muted)] hover:bg-[color-mix(in srgb, var(--bg-muted) 80%, black)] text-sm text-[var(--text-primary)] transition">
        {{ textCancelar }}
      </button>
      }
      @if (showGuardar) {
      <button (click)="guardar.emit()" [disabled]="disableGuardar"
        class="px-4 py-2 rounded bg-[var(--accent)] hover:bg-[var(--accent-hover)] text-[var(--text-inverse)] text-sm disabled:opacity-50 transition">
        {{ textGuardar }}
      </button>
      }
    </div>

  </div>
</div>